<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hi its geography!</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
      :root{
        /* Blue & White theme (Yandex Music-like) */
        --bg-left: #02204a;  /* deep blue */
        --bg-right: #2563eb; /* vivid blue */
        --bg: linear-gradient(135deg, var(--bg-left) 0%, var(--bg-right) 100%);
        --card: #ffffff; /* white cards */
        --accent: #2563eb; /* modern blue */
        --muted: rgba(255,255,255,0.8);
        --glass: rgba(255,255,255,0.04);
        --text: #ffffff; /* default content text (white on blue) */
        --card-text: #061122; /* dark text inside white cards */
        --bg-layer1-angle: 120deg;
        --bg-layer2-angle: 260deg;
        --bg-dur1: 40s;
        --bg-dur2: 60s;
        --bg-size: 240% 240%;
      }
        html,body{height:100%; scroll-behavior:smooth;}
        body{
          margin:0;
          min-height:100%;
          padding-top:64px; /* leave room for sticky nav */
          background:var(--bg);
          color:var(--text);
          font-family:Inter, system-ui, -apple-system, Roboto, 'Segoe UI', 'Helvetica Neue', Arial;
        }
        /* sections */
        .hero{
          position: relative;
          min-height:100vh;
          display:flex;
          justify-content:center;
          align-items:center;
        }
      section{ scroll-margin-top:84px; }
      /* navigation */
      .site-nav{
        position:fixed;
        top:0;
        left:0;
        right:0;
        height:64px;
        background:color-mix(in srgb, var(--glass) 60%, #000 40%);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid rgba(15,23,42,0.04);
        z-index:999;
        display:flex;
        align-items:center;
      }
      .nav-inner{ width:100%; max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:0 1rem; }
      .site-nav .brand{ font-weight:700; color:var(--accent); text-decoration:none; font-size:1.05rem; }
      .nav-links{ display:flex; gap:2rem; align-items:center }
      .nav-links a{ color:var(--muted); text-decoration:none; font-weight:600; padding:6px 10px; border-radius:8px; }
      .nav-links a:hover{ color:var(--accent); background:rgba(37,99,235,0.06); }
      .nav-cta{ background:var(--accent); color:white; padding:8px 12px; border-radius:10px; font-weight:700; text-decoration:none; box-shadow:0 6px 18px rgba(37,99,235,0.12); }
      @media (max-width:600px){
        .nav-links a{ display:none; }
        .nav-inner{ padding:0 0.75rem; }
      }
      .card{
        padding:2rem 3rem;
        border-radius:16px;
        box-shadow: 0 18px 50px rgba(2,6,23,0.6);
        background: #1a1a1a;
        color: #ffffff;
        text-align:center;
      }
          /* keep titles readable inside dark cards */
      .card .title{ color: #ffffff; }
      .card .subtitle{ color: #cccccc; }
      .next-section{ /* section below the hero */
        min-height:100vh;
        padding:4rem 2rem;
        display:flex;
        justify-content:center;
        align-items:center;
      }
      /* map */
      #map { width:100%; height:60vh; min-height:300px; border-radius:12px; }
      /* Background video */
      .bg-video-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2; /* below overlay */
        overflow: hidden;
        pointer-events: none;
      }
      .bg-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        display: block;
      }
      /* subtle overlay above video to keep content readable */
      .bg-overlay {
        position: fixed;
        inset: 0;
        background: linear-gradient(rgba(4,8,20,0.28), rgba(4,8,20,0.28));
        z-index: -1; /* above video, below content */
        pointer-events: none;
      }
      .bg-video-fallback {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -3;
        background-image:
          linear-gradient(var(--bg-layer1-angle), var(--bg-left), var(--bg-right)),
          linear-gradient(var(--bg-layer2-angle), rgba(255,255,255,0.04), rgba(255,255,255,0.02));
        background-size: var(--bg-size);
        animation: bgFloat1 var(--bg-dur1) linear infinite, bgFloat2 var(--bg-dur2) linear infinite;
      }

      /* Performance / accessibility: hide video on small screens and when user prefers reduced motion */
      @media (max-width:700px), (prefers-reduced-motion: reduce) {
        .bg-video { display:none; }
        .bg-overlay { background: transparent; }
      }
      .title{
        font-size: clamp(32px, 10vw, 120px);
        line-height: 1.02;
        margin:0;
        color: var(--text);
        letter-spacing: -0.02em;
        text-shadow: 0 8px 30px rgba(12,13,20,0.035);
      }
      .title .heart{ color:var(--accent); }
      .subtitle{ margin-top:0.5rem; font-size:1rem; color:var(--muted); }
      @media (max-width:480px){
        .card{ padding:1rem 1.25rem; }
      }
      /* arrow button */
      .down-arrow{
        position: absolute;
        bottom: 24px;
        left:50%;
        transform: translateX(-50%);
        background: rgba(255,255,255,0.92);
        border-radius: 999px;
        padding:6px 10px;
        box-shadow: 0 12px 30px rgba(2,6,23,0.06);
        text-decoration:none;
        color:var(--accent);
        font-size:20px;
      }
      .down-arrow:hover{ transform: translateX(-50%) translateY(-4px); }
      /* modern hero text animation */
      .title{ transform-origin:center; transition: transform 450ms cubic-bezier(.2,.9,.3,1), opacity 350ms ease; }
      .title.show{ transform:translateY(0) scale(1); opacity:1; }
      .title.hide{ transform:translateY(6px) scale(0.995); opacity:0.95; }
      /* Nav mobile toggle */
      .hamburger{ display:none; background:none; border:none; font-size:20px; color:var(--muted); }
      .nav-links{ display:flex; align-items:center; }
      @media (max-width:700px){
        .hamburger{ display:block }
        .nav-links{ position:absolute; top:64px; left:0; right:0; background:var(--card); display:none; flex-direction:column; padding:0.5rem 1rem; gap:0.5rem; box-shadow:0 10px 30px rgba(2,6,23,0.06); }
        .nav-open .nav-links{ display:flex }
        .nav-links a{ margin-left:0; }
      }
      /* animate background across two layers */
      @keyframes bgFloat1{
        0%{ background-position: 0% 50%; }
        50%{ background-position: 100% 50%; }
        100%{ background-position: 0% 50%; }
      }
      @keyframes bgFloat2{
        0%{ background-position: 100% 60%; }
        50%{ background-position: 0% 40%; }
        100%{ background-position: 100% 60%; }
      }
    </style>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  </head>
  <body>
      <!-- Background video with fallback gradient -->
      <div class="bg-video-container">
        <video class="bg-video" autoplay muted loop playsinline disablePictureInPicture preload="metadata" aria-hidden="true">
          <source src="background.mp4" type="video/mp4">
        </video>
      </div>
      <div class="bg-overlay" aria-hidden="true"></div>
      <div class="bg-video-fallback" aria-hidden="true"></div>
      
      <nav class="site-nav" role="navigation">
          <div class="nav-inner">
            <a class="brand" href="#hero">Geography</a>
            <button class="hamburger" aria-label="Toggle navigation">‚ò∞</button>
            <div class="nav-links">
              <a href="#hero">Home</a>
              <a href="#page2">About</a>
              <a href="#map">Map</a>
            </div>
          </div>
      </nav>
      <section class="hero" id="hero">
        <div class="card">
          <h1 class="title hide">Hi ‚Äî geography!</h1>
          <div class="subtitle">It's my first project!</div>
          <div style="margin-top:18px;">
            <a class="nav-cta" href="#map">Explore the map</a>
          </div>
        </div>
        <a class="down-arrow" href="#next" aria-label="Scroll down">‚¨á</a>
      </section>

      <!-- Map section -->
      <section id="map" class="next-section" aria-label="Map section">
        <div class="card" style="width:100%; max-width:1100px;">
          <h2 style="margin:0; font-size:clamp(18px,4vw,30px);">Interactive map</h2>
          <div id="map" style="margin-top:1rem;"></div>
          <div id="flight-settings" style="margin-top:10px; display:flex; gap:8px; align-items:center; font-size:14px; color:var(--muted);">
            <label for="maxFlightsRange" style="color:var(--muted);">Max flights</label>
            <input id="maxFlightsRange" type="range" min="1" max="500" value="50" style="vertical-align:middle;" />
            <span id="maxFlightsVal" style="min-width:36px; text-align:left; color:var(--muted);">50</span>
          </div>
        </div>
      </section>

      <!-- Embedded Page 2: so the site can be scrolled down to this 'page' -->
      <section id="page2" class="next-section" aria-label="Embedded Page 2">
        <div class="card" style="width:100%; max-width:900px;">
          <h2 style="margin:0; font-size:clamp(18px,4vw,30px);">It's my first site related to coding! Hurrah... (help)</h2>
          <div style="margin-top:18px;">
            <a class="nav-cta" href="#hero">Back to top</a>
          </div>
        </div>
      </section>

      <script>
        // Leaflet map with live flight data from OpenSky Network (toggleable layer)
        (function(){
          try {
            var defaultLatLng = [51.505, -0.09]; // London
            var map = L.map('map', { scrollWheelZoom:true }).setView(defaultLatLng, 13);
            var flightsEnabled = false; // Flight layer toggle state
            var flightUpdateInterval = null; // Interval handle for cleanup
            var lastFetchTime = 0; // Throttle API requests
            var minUpdateInterval = 8000; // Min 8 seconds between updates
            var consecutiveErrors = 0; // Track consecutive API errors for backoff
            // Maximum number of flight markers to display (user-configurable via UI)
            var maxFlights = 50;
            
            // Base layers
            var cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
              maxZoom: 19,
              attribution: '¬© OpenStreetMap, ¬© CartoDB'
            });
            var openStreet = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '¬© OpenStreetMap'
            });
            // Add default base
            cartoPositron.addTo(map);
            var baseMaps = { 'CartoDB Positron': cartoPositron, 'OpenStreetMap': openStreet };
            
            // Create a clustered flights layer (handles many markers efficiently)
            var flightsLayer = L.markerClusterGroup({
              chunkedLoading: true,
              chunkProgress: function(processed, total, elapsed) {
                if (elapsed > 1000) console.log('MarkerCluster chunked loading: ' + processed + '/' + total);
              },
              showCoverageOnHover: false,
              maxClusterRadius: 50,
              disableClusteringAtZoom: 12
            });
            var overlayMaps = { 'Live Flights': flightsLayer };
            var layerControl = L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

            // Wire up the max flights UI control
            (function(){
              var maxRange = document.getElementById('maxFlightsRange');
              var maxVal = document.getElementById('maxFlightsVal');
              if (maxRange && maxVal) {
                maxFlights = parseInt(maxRange.value, 10) || maxFlights;
                maxVal.textContent = maxFlights;
                maxRange.addEventListener('input', function(){
                  maxFlights = parseInt(this.value, 10) || 1;
                  maxVal.textContent = maxFlights;
                });
              }
            })();

            // Add marker and popup
            var marker = L.marker(defaultLatLng).addTo(map);
            marker.bindPopup('<strong>Welcome to the map!</strong>').openPopup();

            // Try to locate user (permission-based)
            map.locate({ setView: false, maxZoom: 16 });
            map.on('locationfound', function(e){
              var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
              L.circle(e.latlng, { radius: e.accuracy/2, color: accent || '#2563eb', fillColor: accent || '#2563eb', fillOpacity: 0.1 }).addTo(map);
            });

            // Function to create yellow airplane icon (Flightradar style)
            function createAircraftIcon(heading) {
              var svg = '<svg width="24" height="24" viewBox="0 0 24 24" style="transform:rotate('+heading+'deg)" xmlns="http://www.w3.org/2000/svg">' +
                '<path d="M12 2 L14 8 L20 10 L15 15 L16 21 L12 18 L8 21 L9 15 L4 10 L10 8 Z" fill="#FFD700" stroke="#FFA500" stroke-width="0.5"/>' +
                '</svg>';
              return L.divIcon({
                html: svg,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                className: 'aircraft-icon'
              });
            }

            // Fetch live flight data from Glorious API (ADS-B Exchange, more reliable)
            function updateFlights() {
              var now = Date.now();
              // Throttle requests to prevent API spam
              if (now - lastFetchTime < minUpdateInterval) return;
              lastFetchTime = now;
              
              var bounds = map.getBounds();
              var lamin = bounds.getSouth();
              var lamax = bounds.getNorth();
              var lomin = bounds.getWest();
              var lomax = bounds.getEast();

              // Only fetch if flights layer is visible
              if (!map.hasLayer(flightsLayer)) {
                clearAllFlights();
                consecutiveErrors = 0; // Reset error counter when layer is off
                return;
              }

              // Glorious API (ADS-B Exchange) - public endpoint
              var url = 'https://api.glorious.aero/v1/aircraft?bounds=' + lamin + ',' + lomin + ',' + lamax + ',' + lomax;

              fetch(url, { signal: AbortSignal.timeout(8000) })
                .then(function(response) { 
                  if (!response.ok) {
                    if (response.status === 429) {
                      consecutiveErrors++;
                      var backoffMultiplier = Math.min(Math.pow(1.5, consecutiveErrors), 5);
                      var newInterval = Math.floor(8000 * backoffMultiplier);
                      minUpdateInterval = newInterval;
                      console.warn('üõë Rate limited (429). Backing off to ' + (newInterval/1000).toFixed(1) + 's.');
                    }
                    throw new Error('API Error: ' + response.status);
                  }
                  consecutiveErrors = 0; // Success - reset error counter
                  minUpdateInterval = 8000; // Back to normal interval
                  return response.json();
                })
                .then(function(data) {
                  if (!data.ac && !Array.isArray(data)) return;
                  
                  var aircraft = data.ac || data;
                  var markers = [];
                  // Build marker list (we'll add them in bulk to the cluster)
                  for (var i = 0; i < aircraft.length && markers.length < maxFlights; i++) {
                    var state = aircraft[i];
                    var icao24 = state.icao;
                    var callsign = state.flight ? state.flight.trim() : 'Unknown';
                    var lat = state.lat;
                    var lon = state.lon;
                    var altitude = state.alt_baro || state.alt_geom || 0;
                    var heading = state.track || 0;
                    var velocity = state.gs || 0;
                    if (lat === null || lat === undefined || lon === null || lon === undefined) continue;
                    var popupText = '<strong>'+callsign+'</strong><br>Alt: '+Math.round(altitude)+'m<br>Speed: '+Math.round(velocity)+'kt';
                    var m = L.marker([lat, lon], { icon: createAircraftIcon(heading || 0) }).bindPopup(popupText);
                    markers.push(m);
                  }
                  // Replace layer content in bulk for performance
                  flightsLayer.clearLayers();
                  if (markers.length) flightsLayer.addLayers(markers);
                  console.log('‚úàÔ∏è Updated ' + markers.length + ' aircraft (clustered)');
                })
                .catch(function(err) {
                  if (err.name !== 'AbortError') {
                    console.warn('‚ö†Ô∏è Flight API: ' + err.message + ' - Using demo data');
                    // Fallback to demo flights if API fails: build demo markers
                    var demoFlights = generateDemoFlights(map.getBounds());
                    var markers = [];
                    for (var j = 0; j < demoFlights.length && markers.length < maxFlights; j++) {
                      var state = demoFlights[j];
                      var popupText = '<strong>'+state.flight+'</strong> (Demo)<br>Alt: '+Math.round(state.alt_baro)+'m<br>Speed: '+Math.round(state.gs)+'kt';
                      var aircraftMarker = L.marker([state.lat, state.lon], { icon: createAircraftIcon(state.track || 0) }).bindPopup(popupText);
                      markers.push(aircraftMarker);
                    }
                    flightsLayer.clearLayers();
                    if (markers.length) flightsLayer.addLayers(markers);
                  }
                });
            }

            // Clear all flight markers
            function clearAllFlights() {
              flightsLayer.clearLayers();
            }

            // Generate demo flight data (for testing/fallback)
            function generateDemoFlights(bounds) {
              var flights = [];
              var callsigns = ['BA123', 'LH456', 'AF789', 'UA234', 'DL567', 'AA890', 'SQ123', 'QF456', 'EK789', 'TK234'];
              for (var i = 0; i < Math.max(1, Math.min(maxFlights, 200)); i++) {
                flights.push({
                  icao: 'demo' + i,
                  flight: callsigns[i % callsigns.length],
                  lat: bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth()),
                  lon: bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest()),
                  alt_baro: 5000 + Math.random() * 10000,
                  track: Math.random() * 360,
                  gs: 400 + Math.random() * 200
                });
              }
              return flights;
            }

            // Listen for layer visibility changes
            map.on('overlayadd', function(e) {
              if (e.name === 'Live Flights') {
                flightsEnabled = true;
                updateFlights();
                if (flightUpdateInterval) clearInterval(flightUpdateInterval);
                // Use the configured minUpdateInterval for periodic refresh; updateFlights itself throttles too
                flightUpdateInterval = setInterval(updateFlights, Math.max(minUpdateInterval, 8000));
              }
            });

            map.on('overlayremove', function(e) {
              if (e.name === 'Live Flights') {
                flightsEnabled = false;
                if (flightUpdateInterval) clearInterval(flightUpdateInterval);
                clearAllFlights();
              }
            });

            // Update flights on map move/zoom (only if flights enabled)
            map.on('moveend', updateFlights);
            map.on('zoomend', updateFlights);

          } catch (err) {
            console.warn('Leaflet failed to initialize', err);
          }
        })();
          // Small UI JS for toggle and intro animation
          (function(){
            var hamburger = document.querySelector('.hamburger');
            var nav = document.querySelector('.site-nav');
            if(hamburger && nav){
              hamburger.addEventListener('click', function(){ nav.classList.toggle('nav-open'); });
            }
            // animate title in
            var title = document.querySelector('.title');
            if(title){ setTimeout(function(){ title.classList.remove('hide'); title.classList.add('show'); }, 80); }
          })();
      </script>
      <!-- Background randomizer removed to keep background static -->
  </body>
</html>